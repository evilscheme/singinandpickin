---
interface Props {
  content: string;
}

const { content } = Astro.props;

// ChordPro parser with inline chord positioning for mobile-friendly text wrapping
function parseChordPro(text: string): string {
  const lines = text.split('\n');
  let html = '';
  let inChordPro = false;

  for (const line of lines) {
    // Skip code fence markers
    if (line.trim() === '```chordpro' || line.trim() === '```') {
      inChordPro = !inChordPro;
      continue;
    }

    if (!inChordPro && !line.includes('[')) {
      continue;
    }

    // Handle directives
    if (line.startsWith('{') && line.endsWith('}')) {
      const directive = line.slice(1, -1);
      const [cmd, ...valueParts] = directive.split(':');
      const value = valueParts.join(':').trim();

      switch (cmd.toLowerCase()) {
        case 'title':
        case 't':
        case 'subtitle':
        case 'st':
        case 'artist':
          continue;
        case 'comment':
        case 'c':
          html += `<div class="chordpro-comment">${value}</div>`;
          continue;
        case 'soc':
        case 'start_of_chorus':
          html += `<div class="chordpro-section">Chorus</div><div class="pl-4 border-l-4 border-amber-400">`;
          continue;
        case 'eoc':
        case 'end_of_chorus':
          html += `</div>`;
          continue;
        case 'sov':
        case 'start_of_verse':
          html += `<div class="chordpro-section">Verse</div>`;
          continue;
        case 'eov':
        case 'end_of_verse':
          continue;
        case 'sob':
        case 'start_of_bridge':
          html += `<div class="chordpro-section">Bridge</div>`;
          continue;
        case 'eob':
        case 'end_of_bridge':
          continue;
        default:
          if (/verse|chorus|bridge|intro|outro|solo/i.test(cmd)) {
            html += `<div class="chordpro-section">${directive}</div>`;
          }
          continue;
      }
    }

    // Parse lines with chords - use inline positioning for natural text wrapping
    if (line.includes('[')) {
      const chordRegex = /\[([^\]]+)\]/g;
      const chords: Array<{chord: string, index: number, length: number}> = [];
      let match;

      while ((match = chordRegex.exec(line)) !== null) {
        chords.push({ chord: match[1], index: match.index, length: match[0].length });
      }

      let lineHtml = '<div class="chordpro-line">';

      for (let i = 0; i < chords.length; i++) {
        const { chord, index, length } = chords[i];
        const nextIndex = i < chords.length - 1 ? chords[i + 1].index : line.length;

        // Text before first chord
        if (i === 0 && index > 0) {
          const textBefore = line.slice(0, index);
          if (textBefore) {
            lineHtml += `<span class="chord-text">${textBefore}</span>`;
          }
        }

        // Text following this chord
        const textAfter = line.slice(index + length, nextIndex).replace(/\[([^\]]+)\]/g, '');

        if (textAfter) {
          lineHtml += `<span class="chord-word"><span class="chord">${chord}</span>${textAfter}</span>`;
        } else {
          lineHtml += `<span class="chord-word chord-only"><span class="chord">${chord}</span></span>`;
        }
      }

      lineHtml += '</div>';
      html += chords.length > 0 ? lineHtml : '<div class="h-4"></div>';
    } else if (line.trim()) {
      html += `<div class="chordpro-lyrics">${line}</div>`;
    } else {
      html += '<div class="h-4"></div>';
    }
  }

  return html;
}

const parsedContent = parseChordPro(content);
---

{parsedContent && (
  <div class="chord-chart chordpro-container">
    <Fragment set:html={parsedContent} />
  </div>
)}
