---
interface Extra {
  title: string;
  url: string;
  type: 'audio' | 'video';
}

interface Props {
  extras: Extra[];
}

const { extras } = Astro.props;

function getGoogleDriveEmbedUrl(url: string): string | null {
  const match = url.match(/drive\.google\.com\/file\/d\/([^/]+)/);
  if (match) {
    return `https://drive.google.com/file/d/${match[1]}/preview`;
  }
  return null;
}

function getSoundCloudEmbedUrl(url: string): string | null {
  if (url.includes('soundcloud.com')) {
    return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=%23d97706&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false`;
  }
  return null;
}

function getEmbedInfo(extra: Extra): { type: 'gdrive-video' | 'soundcloud' | 'direct'; url: string } {
  if (extra.url.includes('drive.google.com')) {
    if (extra.type === 'video') {
      return { type: 'gdrive-video', url: getGoogleDriveEmbedUrl(extra.url)! };
    }
    // Audio from Google Drive â†’ download link (streaming doesn't work due to CORS/auth)
    return { type: 'direct', url: extra.url };
  }
  if (extra.url.includes('soundcloud.com')) {
    return { type: 'soundcloud', url: getSoundCloudEmbedUrl(extra.url)! };
  }
  return { type: 'direct', url: extra.url };
}
---

{extras && extras.length > 0 && (
  <section class="mb-12">
    <h2 class="font-serif text-2xl font-bold text-earth-900 mb-4">Additional Resources</h2>
    <div class="space-y-4">
      {extras.map((extra) => {
        const embed = getEmbedInfo(extra);
        return (
          <div class="bg-earth-100 rounded-xl p-4 border border-earth-200">
            <h3 class="font-medium text-earth-800 mb-3">{extra.title}</h3>

            {embed.type === 'gdrive-video' && (
              <div class="aspect-video rounded-lg overflow-hidden">
                <iframe
                  src={embed.url}
                  class="w-full h-full"
                  allow="autoplay"
                  allowfullscreen
                  loading="lazy"
                ></iframe>
              </div>
            )}

            {embed.type === 'soundcloud' && (
              <iframe
                width="100%"
                height="166"
                allow="autoplay"
                src={embed.url}
                class="rounded-lg border-0"
              ></iframe>
            )}

            {embed.type === 'direct' && (
              <a
                href={extra.url}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 text-amber-700 hover:text-amber-800 font-medium"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download {extra.type}
              </a>
            )}
          </div>
        );
      })}
    </div>
  </section>
)}
