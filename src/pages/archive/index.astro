---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SongCard from '../../components/SongCard.astro';
import { getCollection } from 'astro:content';

// Get all songs
const allSongs = await getCollection('songs');

// Group songs by year
const songsByYear = allSongs.reduce((acc, song) => {
  const year = song.data.year;
  if (!acc[year]) acc[year] = [];
  acc[year].push(song);
  return acc;
}, {} as Record<number, typeof allSongs>);

// Sort years descending
const years = Object.keys(songsByYear)
  .map(Number)
  .sort((a, b) => b - a);

// Sort songs within each year by date descending
years.forEach((year) => {
  songsByYear[year].sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
});
---

<BaseLayout title="Archive">
  <div class="bg-earth-900 text-white py-16 relative overflow-hidden">
    <!-- Decorative background elements -->
    <div class="absolute inset-0 opacity-5">
      <div class="absolute top-10 left-10 text-9xl">ðŸŽµ</div>
      <div class="absolute bottom-10 right-10 text-9xl">ðŸŽ¶</div>
    </div>

    <div class="max-w-6xl mx-auto px-4 relative z-10">
      <h1 class="font-serif text-5xl md:text-6xl font-bold text-amber-400 mb-4">Song Archive</h1>
      <p class="text-earth-300 text-lg md:text-xl">Browse all the songs we've shared over the years.</p>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-8">
    <!-- Year Navigation -->
    <div class="flex flex-wrap gap-3 mb-12 sticky top-16 bg-earth-50/95 backdrop-blur-sm py-4 z-40 rounded-lg">
      {years.map((year) => (
        <a
          href={`#year-${year}`}
          class="px-5 py-2.5 rounded-full bg-earth-200 text-earth-700 hover:bg-amber-500 hover:text-white transition-all duration-300 font-semibold text-sm hover:shadow-md hover:-translate-y-0.5"
        >
          {year}
          <span class="text-earth-500 ml-1.5 font-normal">({songsByYear[year].length})</span>
        </a>
      ))}
    </div>

    <!-- Songs by Year -->
    {years.map((year) => (
      <section id={`year-${year}`} class="mb-20 scroll-mt-32">
        <!-- Styled year header -->
        <div class="mb-8 animate-on-scroll">
          <div class="flex items-center gap-4">
            <h2 class="font-serif text-4xl md:text-5xl font-bold text-amber-600">{year}</h2>
            <div class="flex-1 h-0.5 bg-gradient-to-r from-amber-400 to-transparent"></div>
            <span class="text-earth-400 text-lg font-medium bg-earth-100 px-4 py-1 rounded-full">
              {songsByYear[year].length} {songsByYear[year].length === 1 ? 'song' : 'songs'}
            </span>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {songsByYear[year].map((song, songIndex) => {
            const songSlug = `${song.data.year}/${song.slug.split('/').pop()}`;
            return (
              <SongCard
                title={song.data.title}
                artist={song.data.artist}
                month={song.data.month}
                year={song.data.year}
                picker={song.data.picker}
                slug={songSlug}
                coverImage={song.data.coverImage}
                youtubeUrl={song.data.youtubeUrl}
                animationDelay={songIndex + 1}
              />
            );
          })}
        </div>
      </section>
    ))}
  </div>
</BaseLayout>
